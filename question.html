<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Fund Calculator</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #ffdada; text-align: center; }
        .container { width: 50%; margin: auto; padding: 20px; background: white; border-radius: 10px; }
        .hidden { display: none; }
        .progress-bar { height: 10px; background: red; width: 0%; }
    </style>
</head>
<body>
    <h1 id="welcomeUser">Welcome</h1>
    <button onclick="logoutUser()">Logout</button>
    <div class="progress-bar" id="progress"></div>
    
    <form id="fund-form">
        <div class="step">
            <label>Monthly Income: <input type="number" id="income" required></label>
        </div>
        <div class="step hidden">
            <label>Rent: <input type="number" id="rent" required></label>
            <label>Food: <input type="number" id="food" required></label>
            <label>Utilities: <input type="number" id="utilities" required></label>
        </div>
        <div class="step hidden">
            <label>Job Stability:
                <select id="job-stability">
                    <option value="stable">Stable</option>
                    <option value="unstable">Unstable</option>
                </select>
            </label>
            <label>Dependents:
                <select id="dependents">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </label>
        </div>
        <div class="step hidden">
            <h2>Summary</h2>
            <canvas id="chartCanvas"></canvas>
            <div id="summary-text"></div>
        </div>
        <button type="button" id="prev" class="hidden">Previous</button>
        <button type="button" id="next">Next</button>
        <button type="button" id="restart" class="hidden">Restart</button>
    </form>

    <script>
        // Firebase Auth
        document.addEventListener("DOMContentLoaded", () => {
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = "loginindex.html";
                } else {
                    document.getElementById("welcomeUser").textContent = `Welcome, ${user.email}`;
                }
            });
        });

        function logoutUser() {
            firebase.auth().signOut().then(() => {
                window.location.href = "loginindex.html";
            }).catch(error => {
                console.error("Logout Error:", error);
            });
        }

        let currentStep = 0;
        const steps = document.querySelectorAll(".step");
        const progress = document.getElementById("progress");
        document.getElementById("next").addEventListener("click", () => {
            const inputs = steps[currentStep].querySelectorAll("input, select");
            for (let input of inputs) {
                if (!input.value) {
                    alert("Please fill out all required fields.");
                    return;
                }
            }
            if (currentStep < steps.length - 1) {
                if (currentStep === steps.length - 2) calculateEmergencyFund();
                currentStep++;
            }
            updateForm();
        });
        document.getElementById("prev").addEventListener("click", () => {
            if (currentStep > 0) currentStep--;
            updateForm();
        });
        document.getElementById("restart").addEventListener("click", () => {
            document.getElementById("fund-form").reset();
            currentStep = 0;
            updateForm();
        });

        function updateForm() {
            steps.forEach((step, index) => step.classList.toggle("hidden", index !== currentStep));
            document.getElementById("prev").classList.toggle("hidden", currentStep === 0);
            document.getElementById("next").classList.toggle("hidden", currentStep === steps.length - 1);
            document.getElementById("restart").classList.toggle("hidden", currentStep === steps.length - 1);
            progress.style.width = `${(currentStep / (steps.length - 1)) * 100}%`;
        }

        function calculateEmergencyFund() {
            const income = parseFloat(document.getElementById("income").value);
            const rent = parseFloat(document.getElementById("rent").value);
            const food = parseFloat(document.getElementById("food").value);
            const utilities = parseFloat(document.getElementById("utilities").value);
            const stability = document.getElementById("job-stability").value;
            const dependents = document.getElementById("dependents").value;
            
            const expenses = rent + food + utilities;
            if (expenses >= income) {
                alert("Your expenses exceed your income. Please enter a higher income.");
                currentStep = 0;
                updateForm();
                return;
            }
            const months = (stability === "unstable" || dependents === "yes") ? 6 : 3;
            const emergencyFund = expenses * months;
            document.getElementById("summary-text").innerHTML = `<p>Your recommended emergency fund is: $${emergencyFund}</p>`;
            renderChart(expenses, months);
        }
        
        function renderChart(expenses, months) {
            const ctx = document.getElementById("chartCanvas").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Monthly Expenses", "Emergency Fund Needed"],
                    datasets: [{
                        label: "Amount in $",
                        data: [expenses, expenses * months],
                        backgroundColor: ["red", "blue"]
                    }]
                }
            });
        }
    </script>
</body>
</html>
